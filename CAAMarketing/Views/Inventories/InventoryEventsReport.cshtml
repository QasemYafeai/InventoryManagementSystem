@model IEnumerable<CAAMarketing.ViewModels.EventReportVM>

@{
    ViewData["Title"] = "InventoryEventsReport";
}

<form asp-controller="Inventories" asp-action="InventoryEventsReport" method="get">
    <input type="hidden" name="sortDirection" value="@ViewData["sortDirection"]" />
    <input type="hidden" name="sortField" value="@ViewData["sortField"]" />
    <!-- Help Section -->
    <div class="container my-3">
        <button type="button" class="btn btn-info btn-color-Create" data-bs-toggle="modal" data-bs-target="#eventsPageHelpModal">
            Need Help? Click here
        </button>
        <!-- Help Modal -->
        <div class="modal fade" id="eventsPageHelpModal" tabindex="-1" aria-labelledby="eventsPageHelpModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="eventsPageHelpModalLabel">How to use the Events page</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="list-group">
                            <div class="list-group-item">
                                <i class="bi bi-filter-square text-primary"></i> <strong>Filter/Search:</strong> Click the "Filter/Search" button to access filtering and search options for the events page. Use this feature to generate a filtered Excel sheet based on your filter and search criteria.
                            </div>
                            <div class="list-group-item">
                                <i class="bi bi-search text-success"></i> <strong>Filter by various criteria:</strong> Use the filter options to search by event name, item name, or other criteria. Click "Filter" to apply the filters, or "Clear" to reset them.
                            </div>
                            <div class="list-group-item">
                                <i class="bi bi-arrow-up-down text-warning"></i> <strong>Sorting:</strong> Click on the column headers (Event Name, Item Name, Quantity, Log Date) to sort the events page by the respective criteria.
                            </div>
                            <div class="list-group-item">
                                <i class="bi bi-download text-info"></i> <strong>Download Report:</strong> Click the "Download" button to download the current events report. If you have applied filters or search criteria, the downloaded Excel sheet will reflect those filters.
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-dark" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="form-horizontal">
        <button class="btn btn-success  @(ViewData["Filtering"])" type="button" data-bs-toggle="collapse" id="filterToggle" data-bs-target="#collapseFilter" aria-expanded="false" aria-controls="collapseFilter" title="Click this to filter/search">
            <i>Filter/Search</i>
        </button>
    </div>
    <div class="collapse" id="collapseFilter">
        <div class="card card-body">
            <div class="row">
                <div class="form-group col-md-4">
                    <label class="control-label">Filter by Locations: (Ctrl + click to multiselect)</label>
                    @Html.ListBox("LocationID", null, htmlAttributes: new { @class = "form-control", @size = 8 })
                    <label>
                        <input class="control-label" type="checkbox" value="true" checked="@(ViewBag.FilterByLowStockLevel?.IsChecked ?? false)" id="FilterByLowStockLevel" name="FilterByLowStockLevel" />
                        Filter items with low stock level (10)
                    </label>
                    <label>
                        <input class="control-label" type="checkbox" value="true" checked="@(ViewBag.FilterByOutOfStockLevel?.IsChecked ?? false)" id="FilterByOutOfStockLevel" name="FilterByOutOfStockLevel" />
                        Filter items with out of stock level (0)
                    </label>
                    <br />
                    <br />
                </div>
                <div class="form-group col-md-4">
                    <label class="control-label">Search Event Name:</label>
                    @Html.TextBox("SearchString1", null, new { @class = "form-control" })

                    <label class="control-label">Min Quantity:</label>
                    <input type="number" id="MinQuantity" name="MinQuantity" value="@ViewBag.MinQuantity?.ToString()" class="form-control">

                    <label class="control-label">Reserved Date From:</label>
                    <input type="date" id="reservedFromDate" name="reservedFromDate" value="@ViewBag.ReservedFromDate?.ToString("yyyy-MM-dd")" class="form-control">

                    <label class="control-label">Return Date From:</label>
                    <input type="date" id="returnFromDate" name="returnFromDate" value="@ViewBag.ReturnFromDate?.ToString("yyyy-MM-dd")" class="form-control">
                </div>
                <div class="form-group col-md-4">
                    <label class="control-label">Search Item Name:</label>
                    @Html.TextBox("SearchString2", null, new { @class = "form-control" })

                    <label class="control-label">Max Quantity:</label>
                    <input type="number" id="MaxQuantity" name="MaxQuantity" value="@ViewBag.MaxQuantity?.ToString()" class="form-control">

                    <label class="control-label">Reserved Date To:</label>
                    <input type="date" id="reservedToDate" name="reservedToDate" value="@ViewBag.ReservedToDate?.ToString("yyyy-MM-dd")" class="form-control">

                    <label class="control-label">Return Date To:</label>
                    <input type="date" id="returnToDate" name="returnToDate" value="@ViewBag.ReturnToDate?.ToString("yyyy-MM-dd")" class="form-control">
                </div>
                <div class="form-group col-md-4 align-self-end">
                    <input type="submit" name="actionButton" value="Filter" title="click here to filter" class="btn-filter" />
                    <a asp-action="InventoryEventsReport" title="Click here to clear the filter" class="btn-clear-barcode">Clear</a>

                    <button asp-action="DownloadInventory" type="submit" name="actionButton" style="float:right" value="Download" title="click here to Download Report" class="btn btn-primary btn-color-Create btn-download" id="quick-report-download-button-hidden" hidden="hidden">
                        <span class="material-icons">download</span> Quick Report Download
                    </button>
                    <button asp-action="DownloadInventory" type="submit" name="actionButton" style="float:right" value="Download" title="click here to Download Report" class="btn btn-primary btn-color-Create btn-download" id="quick-report-download-button">
                        <span class="spinner-border spinner-border-sm d-none" id="Quickdownload-spinner" role="status" aria-hidden="true"></span>
                        <span class="material-icons" style="font-size:17px;">download</span> Quick Report Download
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="table-content">
        <div class="container-fluid">
            <div class="table-responsive">
                <div class="table-wrapper">
                    <div class="table-title d-flex justify-content-between align-items-center">
                        <h2>Inventory Event Report</h2>
                        <div class="col-xs-7">
                            <div style="display: inline-block; margin-right: 20px;">
                                <h5>
                                    Total Quantity: @{
                                        decimal totalQuantity = 0m;
                                        foreach (var item in Model)
                                        {
                                            totalQuantity += item.Quantity;
                                        }

                                        @totalQuantity.ToString()
                                    }
                                </h5>
                            </div>

@*                            <button asp-action="DownloadInventoryEvents" type="submit" name="actionButton" value="Download" title="click here to Download Report" class="btn btn-primary btn-color-Create btn-download">
                                <span class="material-icons">download</span> Download
                                <span class="spinner-border spinner-border-sm d-none" id="download-spinner" role="status" aria-hidden="true"></span>
                            </button>*@

                            <button asp-action="DownloadInventoryEvents" type="submit" name="actionButton" value="Download" title="click here to Download Report" class="btn btn-primary btn-color-Create btn-download" id="download-button">
                                <span class="spinner-border spinner-border-sm d-none" id="download-spinner" role="status" aria-hidden="true"></span>
                                <span class="material-icons">download</span> Download
                            </button>
                            
                            <button asp-action="DownloadInventoryEvents" type="submit" name="actionButton" value="Download" title="click here to Download Report" class="btn btn-primary btn-color-Create btn-download" id="download-button-hidden" hidden="hidden">
                                <span class="material-icons">download</span> Download
                            </button>
                            <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

                            <script>
                                const downloadButton = document.querySelector('#download-button');
                                const hiddenDownloadButton = document.querySelector('#download-button-hidden');

                                const QuickDownloaddownloadButton = document.querySelector('#quick-report-download-button');
                                const QuickDownloadhiddenDownloadButton = document.querySelector('#quick-report-download-button-hidden');

                                downloadButton.addEventListener('click', (event) => {
                                    event.preventDefault();

                                    Swal.fire({
                                        type: 'success',
                                        title: 'Downloading...',
                                        text: 'Your Events Report will download shortly',
                                        showConfirmButton: false,
                                        showProgressSteps: true,
                                        progressSteps: ['1'],
                                        timerProgressBar: true,
                                        onBeforeOpen: () => {
                                            Swal.showLoading();
                                            setTimeout(() => {
                                                Swal.close();
                                            }, 1600);
                                        },
                                        onClose: () => {
                                            // Click the hidden download button to trigger the download
                                            hiddenDownloadButton.click();
                                        }
                                    });
                                });

                                QuickDownloaddownloadButton.addEventListener('click', (event) => {
                                    event.preventDefault();

                                    Swal.fire({
                                        type: 'success',
                                        title: 'Downloading...',
                                        text: 'Your Events Report will download shortly',
                                        showConfirmButton: false,
                                        showProgressSteps: true,
                                        progressSteps: ['1'],
                                        timerProgressBar: true,
                                        onBeforeOpen: () => {
                                            Swal.showLoading();
                                            setTimeout(() => {
                                                Swal.close();
                                            }, 1600);
                                        },
                                        onClose: () => {
                                            // Click the hidden download button to trigger the download
                                            QuickDownloadhiddenDownloadButton.click();
                                        }
                                    });
                                });

                            </script>

                            @*<div class="search-box">
                            <div class="input-group">
                            @*<input type="text" id="InventoryEventReportsearch" class="form-control" placeholder="Search by Event Name">*@
                            @*@Html.TextBox("SearchString3", null, new { @class = "form-control", @placeholder = "Search by Event Name", @id = "InventoryEventReportsearch" })
                            <span class="input-group-addon"><i class="material-icons">&#xE8B6;</i></span>
                            </div>
                            </div>*@
                        </div>
                    </div>

                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>
                                    <input type="submit" name="actionButton" value="Event Name" title="click here to sort by EventName" class="btn btn-link" />
                                </th>
                                <th>
                                    <input type="submit" name="actionButton" value="Reserved Date" title="click here to sort by Reserved Date" class="btn btn-link" />
                                </th>
                                <th>
                                    <input type="submit" name="actionButton" value="Return Date" title="click here to sort by Return Date" class="btn btn-link" />
                                </th>
                                <th>
                                    <input type="submit" name="actionButton" value="Item Name" title="click here to sort by ItemName" class="btn btn-link" />
                                </th>
                                <th>
                                    <input type="submit" name="actionButton" value="Quantity" title="click here to sort by Quantity" class="btn btn-link" />
                                </th>
                                <th>
                                    <input type="submit" name="actionButton" value="Location" title="click here to sort by Location" class="btn btn-link" />
                                </th>
                                @*<th>
                                <input type="submit" name="actionButton" value="LogDate" title="click here to sort by LogDate" class="btn btn-link" />
                                </th>*@
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model)
                            {
                                <tr>
                                    <td>
                                        @Html.DisplayFor(modelItem => item.EventName)
                                    </td>
                                    <td>
                                        @Html.DisplayFor(modelItem => item.ReservedDate)
                                    </td>
                                    <td>
                                        @Html.DisplayFor(modelItem => item.ReturnDate)
                                    </td>
                                    <td>
                                        @Html.DisplayFor(modelItem => item.ItemName)
                                    </td>
                                    <td>
                                        @Html.DisplayFor(modelItem => item.Quantity)
                                    </td>
                                    <td>
                                        @Html.DisplayFor(modelItem => item.Location)
                                    </td>
                                    @* <td>
                                @Html.DisplayFor(modelItem => item.LogDate)
                                </td>*@
                                  @*  <td>
                                        <a asp-controller="Events" asp-action="EventAuditHistory" title="Click this for audit history" class="padding-for-actions" asp-route-id="@item.Id"> Audit History </a>
                                    </td>*@
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    @* <partial name="_PagingNavBar" />*@
</form>

@section Styles {
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" />
}
@section Scripts {
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script type="text/javascript">
        $('#SearchString1').autocomplete({
            minLength: 1,
            source: '@Url.Action("GetItemEvent","Inventories")'
        });
        $('#SearchString2').autocomplete({
            minLength: 1,
            source: '@Url.Action("GetItemNames","Inventories")'
        });

        // Add a click event listener to the Download button
        $('.btn-download').on('click', function () {
            var spinner = $('#download-spinner');
            spinner.toggleClass('d-none');
        });

        // Add a click event listener to the Download button
        $('.btn-download').on('click', function () {
            var spinner = $('#Quickdownload-spinner');
            spinner.toggleClass('d-none');
        });
    </script>
}

<script>
    $(document).ready(function () {
        // Activate tooltips
        $('[data-toggle="tooltip"]').tooltip();

        // Filter table rows based on searched term
        $("#InventoryEventReportsearch").on("keyup", function () {
            var term = $(this).val().toLowerCase();
            $("table tbody tr").each(function () {
                $row = $(this);
                var name = $row.find("td:nth-child(1)").text().toLowerCase();
                console.log(name);
                if (name.search(term) < 0) {
                    $row.hide();
                } else {
                    $row.show();
                }
            });
        });
    });
</script>